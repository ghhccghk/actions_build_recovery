name: rec-building

on:
  watch:
    types: [started]
    
jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-18.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@main
      
    - name: Clean Up
      run: |
        docker rmi `docker images -q`
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/sudo apt/sources.list.d
        sudo apt -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php*
        sudo apt update
        sudo apt -y autoremove --purge
        sudo apt clean
        
    - name: Update packages
      run: |
        sudo apt update
        sudo apt full-upgrade
        
    - name: Install required packages
      run: |
        cd ~
        sudo apt -y install git aria2
        mkdir workspace
        cd workspace
        git clone https://gitlab.com/OrangeFox/misc/scripts
        cd scripts
        sudo bash setup/android_build_env.sh
        sudo bash setup/install_android_sdk.sh || true

    - name: Get variables
      run: |
        echo "::set-output name=twrp_url::$(jq -r '.twrp_url' config.json)"
        echo "::set-output name=twrp_branch::$(jq -r '.twrp_branch' config.json)"
        echo "::set-output name=git_username::$(jq -r '.git_username' config.json)"
        echo "::set-output name=git_email::$(jq -r '.git_email' config.json)"
        echo "::set-output name=use_own_dt::$(jq -r '.use_own_dt' config.json)"
        echo "::set-output name=dt_url::$(jq -r '.dt_url' config.json)"
        echo "::set-output name=dt_remote::$(jq -r '.dt_remote' config.json)"
        echo "::set-output name=dt_branch::$(jq -r '.dt_branch' config.json)"
        echo "::set-output name=dt_path::$(jq -r '.dt_path' config.json)"
        echo "::set-output name=device_code::$(jq -r '.device_code' config.json)"
        echo "::set-output name=fix_product::$(jq -r '.fix_product' config.json)"
        echo "::set-output name=fix_misscom::$(jq -r '.fix_misscom' config.json)"
        echo "::set-output name=fix_busybox::$(jq -r '.fix_busybox' config.json)"
        echo "::set-output name=fix_branch::$(jq -r '.fix_branch' config.json)"
        echo "::set-output name=date::$(date +%F)"
      id: var

    - name: Initialize a Repo client
      run: |
        PATH=~/bin:$PATH
        mkdir workspace
        cd ~/workspace
        echo "::set-output name=pwd::$(pwd)"
        git config --global user.name "${{ steps.var.outputs.git_username }}"
        git config --global user.email "${{ steps.var.outputs.git_email }}"
        git clone https://gitlab.com/OrangeFox/sync.git
        cd ~/workspace/OrangeFox_sync/sync/
        ./orangefox_sync.sh --branch 10.0 --path ~/workspace/OrangeFox
        cd ~/workspace/OrangeFox
        git clone ${{ github.event.inputs.dt_remote }}${{ github.event.inputs.dt_url }}.git -b ${{ github.event.inputs.dt_path }}
      id: pwd

    - name: Start Building
      run: |
        PATH=~/bin:$PATH
        cd ~/workspace/OrangeFox
        ls
        tree device
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        export FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER=1
        lunch twrp_${{ steps.var.outputs.device_code }}-eng
        mka recoveryimage -j$(nproc --all)
        
    - name: Upload REC
      uses: softprops/action-gh-release@v1
      with:
        files: workspace/out/target/product/${{ steps.var.outputs.device_code }}/OrangeFox-unofficial-[${{ steps.var.outputs.device_code }}.img
        name: ${{ steps.var.outputs.date }} ${{ steps.var.outputs.device_code }} by ${{ steps.var.outputs.git_username }}
        tag_name: ${{ github.run_id }}
        body: Android Third-Party Recovery built by ${{ steps.var.outputs.git_username }}
      env:
        GITHUB_TOKEN: ${{ secrets.helpmi }}
